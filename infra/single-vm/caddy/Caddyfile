# =============================================================================
# Caddyfile - Reverse Proxy Configuration
# =============================================================================
# Caddy automatically handles:
#   - SSL/TLS certificates via Let's Encrypt (ACME)
#   - HTTP to HTTPS redirect
#   - HTTP/2 and HTTP/3 support
#   - OCSP stapling
#   - Certificate renewal
#
# SSL/TLS Configuration Options:
#   - Default: Automatic Let's Encrypt certificates
#   - Custom certs: Use 'tls /path/to/cert.pem /path/to/key.pem'
#   - Internal CA: Use 'tls internal' for self-signed
#   - Disable HTTPS: Use 'http://' prefix (not recommended)
# =============================================================================

# -----------------------------------------------------------------------------
# Global Options (uncomment to customize)
# -----------------------------------------------------------------------------
{
    # Email for Let's Encrypt account (receives expiry notices)
    email {$CADDY_EMAIL:admin@localhost}

    # Staging Let's Encrypt (for testing - avoids rate limits)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory

    # Use ZeroSSL instead of Let's Encrypt
    # acme_ca https://acme.zerossl.com/v2/DV90

    # Disable automatic HTTPS (not recommended)
    # auto_https off

    # Custom certificate storage location
    # storage file_system /data/caddy
}

# -----------------------------------------------------------------------------
# Main Site Configuration
# -----------------------------------------------------------------------------
{$DOMAIN_NAME:localhost} {
    # ---------------------------------------------------------------------------
    # TLS/SSL Configuration
    # ---------------------------------------------------------------------------
    # Option 1: Automatic Let's Encrypt (default)
    tls {$CADDY_EMAIL:admin@localhost}

    # Option 2: Custom certificates (uncomment and set paths)
    # tls /etc/caddy/certs/cert.pem /etc/caddy/certs/key.pem

    # Option 3: Self-signed for internal/development use
    # tls internal

    # Option 4: Custom TLS settings
    # tls {
    #     protocols tls1.2 tls1.3
    #     ciphers TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    #     curves x25519 secp384r1
    #     alpn h2 http/1.1
    # }

    # ---------------------------------------------------------------------------
    # Logging
    # ---------------------------------------------------------------------------
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }

    # ---------------------------------------------------------------------------
    # Security Headers
    # ---------------------------------------------------------------------------
    header {
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        # XSS protection
        X-XSS-Protection "1; mode=block"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server header
        -Server
    }

    # ---------------------------------------------------------------------------
    # API Routes -> Backend
    # ---------------------------------------------------------------------------
    handle /api/* {
        reverse_proxy backend:8000 {
            # Health checks for load balancing
            health_uri /health/live
            health_interval 30s
            health_timeout 5s

            # Headers
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # ---------------------------------------------------------------------------
    # Health Check Routes -> Backend
    # ---------------------------------------------------------------------------
    handle /health/* {
        reverse_proxy backend:8000
    }

    # ---------------------------------------------------------------------------
    # API Documentation -> Backend
    # ---------------------------------------------------------------------------
    handle /docs* {
        reverse_proxy backend:8000
    }

    handle /openapi.json {
        reverse_proxy backend:8000
    }

    handle /redoc* {
        reverse_proxy backend:8000
    }

    # ---------------------------------------------------------------------------
    # All Other Routes -> Frontend
    # ---------------------------------------------------------------------------
    handle {
        reverse_proxy frontend:80 {
            health_uri /health
            health_interval 30s
        }
    }
}

# -----------------------------------------------------------------------------
# HTTP to HTTPS Redirect (automatic, but explicit for clarity)
# -----------------------------------------------------------------------------
http://{$DOMAIN_NAME:localhost} {
    redir https://{host}{uri} permanent
}

# -----------------------------------------------------------------------------
# Localhost Development (HTTP only, no SSL)
# -----------------------------------------------------------------------------
:80 {
    @localhost host localhost
    handle @localhost {
        # API routes
        handle /api/* {
            reverse_proxy backend:8000
        }

        handle /health/* {
            reverse_proxy backend:8000
        }

        handle /docs* {
            reverse_proxy backend:8000
        }

        handle /openapi.json {
            reverse_proxy backend:8000
        }

        # Frontend
        handle {
            reverse_proxy frontend:80
        }
    }
}
